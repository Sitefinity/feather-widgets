!function(l){"use strict";function e(t){null==t||0===t.length?t="/":"/"!==t.charAt(t.length-1)&&(t+="/"),this.rootUrl=t}function t(){var t=l('[data-sf-role="comments-count-wrapper"]').find('[data-sf-role="service-url"]').val();new e(t).initialize()}e.prototype={getIsReviewThreadKey:function(t){var e="_review";return 0<=t.indexOf(e,t.length-e.length)},makeAjax:function(t,e){return l.ajax({type:e||"GET",url:t,contentType:"application/json",cache:!1,accepts:{text:"application/json"},processData:!1})},collectThreadIds:function(){for(var t=l('[data-sf-role="comments-count-wrapper"]'),e={},n=0;n<t.length;n++)e[l(t[n]).attr("data-sf-thread-key")]=!0;var o=[];return l.each(e,function(t){o.push(t)}),o},getCommentsCounts:function(t){var e=this.rootUrl+"comments/count?ThreadKey="+encodeURIComponent(t);return this.makeAjax(e).then(function(t){if(t&&t.Items)return t.Items})},getReviewsCounts:function(t){var e=this.rootUrl+"comments/reviews_statistics?ThreadKey="+encodeURIComponent(t);return this.makeAjax(e)},getCommentsAndReviewsCounts:function(t,e){var n=this,o=[];return n.getCommentsCounts(t).then(function(t){return t&&t.length&&(o=o.concat(t)),n.getReviewsCounts(e).then(function(t){return t&&t.length&&(o=o.concat(t)),o})})},getAllCounts:function(){var e=this,t=this.collectThreadIds(),n=t.filter(function(t){return!e.getIsReviewThreadKey(t)}),o=t.filter(function(t){return e.getIsReviewThreadKey(t)});return 0<n.length&&0<o.length?this.getCommentsAndReviewsCounts(n,o):0<n.length?this.getCommentsCounts(n):0<o.length?this.getReviewsCounts(o):{then:function(t){t([])}}},setCommentsCounts:function(){var n=this;n.getAllCounts().then(function(t){for(var e=0;e<t.length;e++)0<=t[e].Count&&l('div[data-sf-thread-key="'+t[e].Key+'"]').each(n.populateCommentsCountTextCallBack(t[e].Count,t[e].AverageRating))})},populateCommentsCountTextCallBack:function(n,o){var a=this;return function(t,e){a.populateCommentsCountText(l(e),n,o)}},populateCommentsCountText:function(t,e,n){var o=JSON.parse(t.find('[data-sf-role="comments-count-resources"]').val()),a="";e?(a=e,a+=1==e?" "+o.comment.toLowerCase():" "+o.commentsPlural.toLowerCase()):a=o.leaveComment,t.find('[data-sf-role="comments-count-anchor-text"]').text(a),e&&n&&this.renderAverageRating(t,n,e)},renderAverageRating:function(t,e,n,o){var a=t.find('[data-sf-role="list-rating-wrapper"]').show(),r=a.find('[data-sf-role="list-rating-value"]'),i=r.text().trim(),s=a.find('[data-sf-role="list-rating-sr-label"]');i&&(e=((n-1)*parseFloat(i)+e)/n);e=Math.round(100*e)/100;var u=a.find('[data-sf-role="list-rating-container"]').mvcRating({readOnly:!0,value:e,template:l('[data-sf-role="rating-template"]')});if(r.text(e),0<s.length){var c=t.find('[data-sf-role="rating-of-resource"]').val().toLocaleLowerCase();s.text(c+" "+u.settings.maxValue)}},initialize:function(){var n=this;n.setCommentsCounts(),l(document).on("sf-comments-count-received",function(t,e){l('div[data-sf-thread-key="'+e.key+'"]').each(n.populateCommentsCountTextCallBack(e.count,e.rating))})}},window.personalizationManager?window.personalizationManager.addPersonalizedContentLoaded(function(){new t}):l(function(){new t})}(jQuery);
//# sourceMappingURL=comments-count.test.min.js.map