!function(o){"use strict";function t(e,t,n,s){this.rootUrl=e&&"/"!==e[e.length-1]?e+"/":e,this.createCommentUrl=t&&"/"!==t[t.length-1]?t+"/":t,this.isUserAuthenticatedUrl=n&&"/"!==n[n.length-1]?n+"/":n,this.hasUserAlreadyReviewedUrl=s&&"/"!==s[s.length-1]?s+"/":s}function s(e,t,n){this.settings=t||{},this.resources=n||{},this.wrapper=e,this.commentsTakenSoFar=0,this.maxCommentsToShow=0,this.allCommentsCount=0,this.lastCommentDate=0,this.commentsSortedDescending=t.commentsInitiallySortedDescending}function e(){o('[data-sf-role="comments-wrapper"]').each(function(){var e=o(this),t=JSON.parse(e.find('[data-sf-role="comments-settings"]').val()),n=JSON.parse(e.find('[data-sf-role="comments-resources"]').val());new s(e,t,n).initialize()})}s.prototype={isUserAuthenticated:!(t.prototype={getRandomNumber:function(){return Math.random().toString().substr(2)+(new Date).getTime()},makeAjax:function(e,t,n){var s={type:t||"GET",url:e,contentType:"application/json",accepts:{text:"application/json"},cache:!1};return n&&(s.data=n),o.ajax(s)},getCommentsCount:function(s,e){var t=this.rootUrl+"comments/count?ThreadKey="+s;return e&&(t+="&Status="+e),this.makeAjax(t).then(function(e){var t=0;if(e&&e.Items)for(var n=0;n<e.Items.length;n++)if(e.Items[n].Key===s){t=e.Items[n].Count;break}return t})},getComments:function(e,t,n,s,i,o){var r=this.rootUrl+"comments/?ThreadKey="+e;return n&&0<n&&(r+="&Take="+n),t&&0<t&&(r+="&Skip="+t),!0===s&&(r+="&SortDescending=True"),o&&(r+="&Language="+o),i&&(r+="&NewerThan="+encodeURIComponent(i)),this.makeAjax(r)},createComment:function(e){var t=this.createCommentUrl||this.rootUrl+"comments";return this.makeAjax(t,"POST",JSON.stringify(e))},getSubscriptionStatus:function(e){var t=this.rootUrl+"notifications/?threadKey="+e;return this.makeAjax(t)},toggleSubscription:function(e,t){var n=this.rootUrl+"notifications/";return n+=t?"unsubscribe/":"subscribe/",n+="?threadKey="+e,this.makeAjax(n,"POST")},getCaptcha:function(){var e=this.rootUrl+"captcha";return this.makeAjax(e)},getIsUserAuthenticated:function(){var e=this.isUserAuthenticatedUrl;return e+="?_="+this.getRandomNumber(),this.makeAjax(e)},getHasUserAlreadyReviewed:function(e){var t=this.hasUserAlreadyReviewedUrl;return t+="?ThreadKey="+e,t+="&_="+this.getRandomNumber(),this.makeAjax(t)}}),hasUserReviewed:!1,isSelectedSortButtonCssClass:"selected",getOrInitializeProperty:function(e,t){return this[e]||(this[e]=this.getElementByDataSfRole(t)),this[e]},getElementByDataSfRole:function(e){return this.wrapper.find('[data-sf-role="'+e+'"]')},getSingleCommentTemplate:function(){return this.singleCommentTemplate||(this.settings.singleCommentTemplate?this.singleCommentTemplate=this.settings.singleCommentTemplate:this.singleCommentTemplate=o(this.getElementByDataSfRole("single-comment-template").html()).first()),this.singleCommentTemplate},commentsContainer:function(){return this.getOrInitializeProperty("_commentsContainer","comments-container")},commentsTotalCount:function(){return this.getOrInitializeProperty("_commentsTotalCount","comments-total-count")},commentsHeader:function(){return this.getOrInitializeProperty("_commentsHeader","comments-header")},commentsLoadMoreButton:function(){return this.getOrInitializeProperty("_commentsLoadMoreButton","comments-load-more-button")},commentsNewLoggedOutView:function(){return this.getOrInitializeProperty("_commentsNewLoggedOutView","comments-new-logged-out-view")},newCommentForm:function(){return this.getOrInitializeProperty("_newCommentForm","comments-new-form")},newCommentPendingApprovalMessage:function(){return this.getOrInitializeProperty("_newCommentPendingApprovalMessage","comments-new-pending-approval-message")},newCommentFormButton:function(){return this.getOrInitializeProperty("_newCommentFormButton","comments-new-form-button")},newCommentSubmitButton:function(){return this.getOrInitializeProperty("_newCommentSubmitButton","comments-new-submit-button")},newCommentMessage:function(){return this.getOrInitializeProperty("_newCommentMessage","comments-new-message")},newCommentRating:function(){return this.getOrInitializeProperty("_newCommentRating","submit-rating-container")},newCommentName:function(){return this.getOrInitializeProperty("_newCommentName","comments-new-name")},newCommentEmail:function(){return this.getOrInitializeProperty("_newCommentEmail","comments-new-email")},newCommentRequiresAuthentication:function(){return this.getOrInitializeProperty("_newCommentRequiresAuthentication","comments-new-requires-authentication")},commentsSortNewButton:function(){return this.getOrInitializeProperty("_commentsSortNewButton","comments-sort-new-button")},commentsSortOldButton:function(){return this.getOrInitializeProperty("_commentsSortOldButton","comments-sort-old-button")},captchaContainer:function(){return this.getOrInitializeProperty("_captchaContainer","captcha-container")},captchaImage:function(){return this.getOrInitializeProperty("_captchaImage","captcha-image")},captchaInput:function(){return this.getOrInitializeProperty("_captchaInput","captcha-input")},captchaRefreshLink:function(){return this.getOrInitializeProperty("_captchaRefreshLink","captcha-refresh-button")},errorMessage:function(){return this.getOrInitializeProperty("_errorMessage","error-message")},listLoadingIndicator:function(){return this.getOrInitializeProperty("_listLoadingIndicator","list-loading-indicator")},submitLoadingIndicator:function(){return this.getOrInitializeProperty("_submitLoadingIndicator","submit-loading-indicator")},commentsSubscribeText:function(){return this.getOrInitializeProperty("_commentsSubscribeText","comments-subscribe-text")},commentsSubscribeButton:function(){return this.getOrInitializeProperty("_commentsSubscribeButton","comments-subscribe-button")},commentsSubscribeButtonText:function(){return this.getOrInitializeProperty("_commentsSubscribeButtonText","comments-subscribe-button-text")},newReviewFormReplacement:function(){return this.getOrInitializeProperty("_newReviewFormReplacement","review-new-form-replacement")},getSfStringFromDate:function(e){return"/Date("+e.getTime()+")/"},getDateFromSfString:function(e){return new Date(parseInt(e.replace(/\D/g,""),10))},getDateString:function(e,t){var n=this.getDateFromSfString(e);return this.settings.alwaysUseUtc||n.setMinutes(n.getMinutes()+n.getTimezoneOffset()),n.setSeconds(n.getSeconds()+t),n.toISOString()},isValidEmail:function(e){return/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(e)},getErrorMessage:function(e,t){var n;return t.attr("id")?(t.next().attr("id")?n=t.next():(n=this.errorMessage().clone(!0),o(n).attr("id",t.attr("id")+"-ErrorMsg")),n.find("span").text(e),n.show()):(n=this.errorMessage().clone(!0).show()).find("span").text(e),n},validateComment:function(e){var t=this,n=o.Deferred(),s=!0,i="aria-describedby";return e.Message.length<1&&(s=!1,this.newCommentMessage().after(this.getErrorMessage(this.resources.messageIsRequired,this.newCommentMessage())),this.newCommentMessage().attr("id")&&this.newCommentMessage().attr(i,this.newCommentMessage().next().attr("id"))),!this.isUserAuthenticated&&e.Name.length<1&&(s=!1,this.newCommentName().after(this.getErrorMessage(this.resources.nameIsRequired,this.newCommentName())),this.newCommentName().attr("id")&&this.newCommentName().attr(i,this.newCommentName().next().attr("id"))),this.isUserAuthenticated||!e.Email||this.isValidEmail(e.Email)||(s=!1,this.newCommentEmail().after(this.getErrorMessage(this.resources.invalidEmailFormat,this.newCommentEmail())),this.newCommentEmail().attr("id")&&this.newCommentEmail().attr(i,this.newCommentEmail().next().attr("id"))),this.settings.useReviews&&!e.Rating&&(s=!1,this.newCommentRating().after(this.getErrorMessage(this.resources.ratingIsRequired,this.newCommentRating())),this.newCommentRating().attr("id")&&this.newCommentRating().find("input").each(function(){o(this).attr(i,t.newCommentRating().next().attr("id"))})),n.resolve(s),n.promise()},attachCommentMessage:function(e,t){if(e&&t){var n=t.replace(/<[^>]*>/gi," ");n.length<this.settings.commentsTextMaxLength?e.html(t):(e.append(o('<p data-sf-role="comments-read-substr-comment-header" />').html(n.substr(0,this.settings.commentsTextMaxLength))),e.append(o("<span />").hide().html(t)),e.append(o('<a href="#" data-sf-role="comments-read-full-comment-button" />').text(this.settings.useReviews?this.resources.readFullReview:this.resources.readFullComment)))}},htmlEncode:function(e){return o("<div/>").text(e).html()},createCommentMarkup:function(e){var t=this.getSingleCommentTemplate().clone(!0);if(t.find('[data-sf-role="list-rating-wrapper"]').show(),t.find('[data-sf-role="comment-avatar"]').attr("src",e.ProfilePictureThumbnailUrl).attr("alt",e.Name),t.find('[data-sf-role="comment-name"]').text(e.Name),t.find('[data-sf-role="comment-date"]').text(this.getDateFromSfString(e.DateCreated).toDateString()),this.attachCommentMessage(t.find('[data-sf-role="comment-message"]'),e.Message),this.settings.useReviews){var n=t.find('[data-sf-role="rating-of-resource"]'),s=t.find('[data-sf-role="list-rating-container"]').mvcRating({readOnly:!0,value:e.Rating,template:o('[data-sf-role="rating-template"]')});if(t.find('[data-sf-role="list-rating-value"]').text(e.Rating),0<n.length){var i=n.val().toLocaleLowerCase();t.find('[data-sf-role="list-rating-sr-label"]').text(i+" "+s.settings.maxValue)}}return t},renderComments:function(e,n,s){if(e&&e.length){var i=this;e.forEach(function(e){var t=i.createCommentMarkup(e);s?(n.prepend(t),i.commentsTakenSoFar>i.maxCommentsToShow&&(n.children().slice(-1*(i.commentsTakenSoFar-i.maxCommentsToShow)).remove(),i.commentsTakenSoFar=i.maxCommentsToShow)):n.append(t)})}},renderCommentsCount:function(){var e=this.settings.useReviews?this.resources.reviewSingular:this.resources.commentSingular,t=this.settings.useReviews?this.resources.reviewPlural:this.resources.commentsPlural,n=1<this.allCommentsCount?t:e;this.commentsHeader().text(0<this.allCommentsCount?n:this.newCommentFormButton().text()),this.commentsTotalCount().toggle(0<this.allCommentsCount).text(this.allCommentsCount),this.newCommentFormButton().css("display",!(0<this.allCommentsCount)||this.settings.useReviews&&this.hasUserReviewed?"none":"inline-block"),this.commentsSortNewButton().css("display",1<this.allCommentsCount?"inline-block":"none"),this.commentsSortOldButton().css("display",1<this.allCommentsCount?"inline-block":"none"),this.commentsLoadMoreButton().css("display",this.allCommentsCount>Math.max(this.commentsTakenSoFar,this.settings.commentsPerPage)?"inline-block":"none"),this.getElementByDataSfRole("comments-count-list-wrapper").toggle(0!==this.allCommentsCount),this.getElementByDataSfRole("comments-count-anchor").hide()},loadComments:function(e,t,n){var s=this;if(!s.isLoadinglist)return s.isLoadingList=!0,s.listLoadingIndicator().show(),s.restApi.getComments(s.settings.commentsThreadKey,e,t,s.commentsSortedDescending,n).then(function(e){return e&&e.Items&&e.Items.length&&(s.commentsTakenSoFar+=e.Items.length,s.renderCommentsCount(),s.renderComments(e.Items,s.commentsContainer(),n&&s.commentsSortedDescending)),e}).always(function(){s.listLoadingIndicator().hide(),s.isLoadingList=!1})},refreshLastCommentDate:function(e){if(e&&e.Items&&e.Items.length){var t=this.commentsSortedDescending?e.Items[0]:e.Items[e.Items.length-1];this.lastCommentDate=this.getDateString(t.DateCreated,1)}},setAllCommentsCount:function(e,t,n){this.allCommentsCount=e,this.renderCommentsCount(),n||o(document).trigger("sf-comments-count-received",{key:this.settings.commentsThreadKey,count:this.allCommentsCount,rating:t})},refreshComments:function(t,e,n){var s=t.commentsSortedDescending?t.settings.commentsPerPage:t.maxCommentsToShow-t.commentsTakenSoFar;!t.commentsSortedDescending&&s<=0&&e?t.setAllCommentsCount(t.allCommentsCount+1):t.loadComments(0,s,t.lastCommentDate).then(function(e){t.refreshLastCommentDate(e),e&&e.TotalCount&&t.setAllCommentsCount(t.allCommentsCount+e.TotalCount,n)})},sortComments:function(e){var t=this;t.commentsSortedDescending!==e&&(t.commentsSortedDescending=e,t.commentsContainer().html(""),t.commentsTakenSoFar=0,t.loadComments(0,t.settings.commentsPerPage).then(function(){t.renderCommentsCount()}))},toggleSubscription:function(){var n=this;n.restApi.toggleSubscription(n.settings.commentsThreadKey,n.isSubscribedToNewComments).then(function(e){n.isSubscribedToNewComments=!n.isSubscribedToNewComments,n.commentsSubscribeButtonText().text(n.isSubscribedToNewComments?n.resources.unsubscribeLink:n.resources.subscribeLink);var t=n.settings.useReviews?n.resources.successfullySubscribedToNewReviews:n.resources.successfullySubscribedToNewComments;n.commentsSubscribeText().text(n.isSubscribedToNewComments?t:n.resources.successfullyUnsubscribedFromNewComments)})},buildNewCommentFromForm:function(){var e=this,t={Message:e.htmlEncode(e.newCommentMessage().val()),ThreadKey:e.settings.commentsThreadKey};return e.settings.useReviews&&(t.Rating=this.newCommentRatingContainer.getValue()),e.isUserAuthenticated||(t.Name=e.newCommentName().val(),t.Email=e.newCommentEmail().val(),e.settings.requiresCaptcha&&(t.Captcha={Answer:e.captchaInput().val(),Key:e.captchaData.key})),t.Thread=e.settings.commentsThread||{},t.Thread.Group=t.Thread.Group||{},t.Thread.Group.Key=t.Thread.Group.Key||t.Thread.groupKey,t},cleanNewCommentForm:function(){this.newCommentMessage().val(""),this.newCommentName().val(""),this.newCommentEmail().val(""),this.newCommentRatingContainer&&this.newCommentRatingContainer.setValue(0)},endSubmitNewComment:function(){!this.isUserAuthenticated&&this.settings.requiresCaptcha&&this.captchaRefresh(),this.submitLoadingIndicator().hide(),this.newCommentSubmitButton().show()},createCommentSuccess:function(e){if(this.cleanNewCommentForm(),this.settings.requiresApproval)this.newCommentPendingApprovalMessage().show();else if(!this.settings.commentsAutoRefresh){var t=this.settings.useReviews&&e?e.Rating:null;this.refreshComments(this,!0,t)}if(this.settings.useReviews){this.newCommentForm().hide(),this.newCommentFormButton().hide(),this.hasUserReviewed=!0;var n=this.settings.requiresApproval?this.newCommentPendingApprovalMessage().text():this.resources.thankYouReviewSubmited;this.newReviewFormReplacement().text(n).show()}},createCommentFail:function(e){if(e&&e.responseText){var t=JSON.parse(e.responseText).ResponseStatus.Message;this.newCommentSubmitButton().before(this.getErrorMessage(t,this.newCommentSubmitButton()))}},submitNewComment:function(){var t=this;t.submitLoadingIndicator().show(),t.newCommentSubmitButton().hide();var n=t.buildNewCommentFromForm(),e=JSON.parse(JSON.stringify(n));e.Message=e.Message.trim(),t.validateComment(e).then(function(e){e?(n.Message=n.Message.replace(new RegExp("\\n","g"),"<br />"),t.restApi.createComment(n).then(function(e){t.createCommentSuccess(e)},function(e){t.createCommentFail(e)}).always(function(){t.endSubmitNewComment()})):t.endSubmitNewComment()})},captchaRefresh:function(){var t=this,n=o.Deferred();t.captchaImage().attr("src",""),t.captchaInput().hide(),t.restApi.getCaptcha().then(function(e){e&&(t.captchaImage().attr("src","data:image/png;base64,"+e.Image),t.captchaData.key=e.Key,t.captchaInput().val(""),t.captchaInput().show()),n.resolve(!0)})},setupCaptcha:function(){!this.isUserAuthenticated&&this.settings.requiresCaptcha&&(this.captchaData={key:null},this.captchaRefresh(),this.captchaContainer().show())},initializeProperties:function(){this.restApi=new t(this.settings.rootUrl,this.settings.createCommentUrl,this.settings.isUserAuthenticatedUrl,this.settings.hasUserAlreadyReviewedUrl),this.isLoadingList=!1,this.isSubscribedToNewComments=!1,this.maxCommentsToShow=this.settings.commentsPerPage;var e=this.newCommentRating();e&&e.length&&(this.newCommentRatingContainer=e.mvcRating({template:o('[data-sf-role="rating-template"]')})),this.newCommentRequiresAuthentication().hide(),this.newCommentPendingApprovalMessage().hide(),this.settings.useReviews&&this.newReviewFormReplacement().hide(),this.commentsSortedDescending?this.commentsSortNewButton().addClass(this.isSelectedSortButtonCssClass):this.commentsSortOldButton().addClass(this.isSelectedSortButtonCssClass)},initializeUserStatus:function(){var t=this;t.restApi.getIsUserAuthenticated().then(function(e){e&&(e.IsAuthenticated?(t.isUserAuthenticated=!0,t.initializeSubscription()):(t.commentsSubscribeText().hide(),t.commentsSubscribeButton().hide(),t.settings.requiresAuthentication&&(t.newCommentForm().hide(),t.newCommentRequiresAuthentication().show())),t.settings.useReviews&&t.initializeHasUserAlreadyReviewed()),o.proxy(t.setupCaptcha(),t)})},initializeSubscription:function(){var s=this;s.settings.commentsThreadKey&&s.restApi.getSubscriptionStatus(s.settings.commentsThreadKey).then(function(e){if(e){s.isSubscribedToNewComments=e.IsSubscribed;var t=s.settings.useReviews?s.resources.subscribeToNewReviews:s.resources.subscribeToNewComments,n=s.settings.useReviews?s.resources.youAreSubscribedToNewReviews:s.resources.youAreSubscribedToNewComments;s.commentsSubscribeButtonText().text(s.isSubscribedToNewComments?s.resources.unsubscribeLink:t),s.commentsSubscribeText().text(s.isSubscribedToNewComments?n:""),s.commentsSubscribeButton().click(function(){return s.toggleSubscription(),!1})}})},initializeComments:function(){var t=this;t.settings.commentsThreadKey&&(t.restApi.getCommentsCount(t.settings.commentsThreadKey).then(function(e){t.setAllCommentsCount(e,null,!0)}),t.loadComments(0,t.settings.commentsPerPage).then(function(e){t.refreshLastCommentDate(e)}),t.settings.commentsAutoRefresh&&setInterval(function(){t.refreshComments(t)},t.settings.commentsRefreshInterval))},initializeHasUserAlreadyReviewed:function(){var t=this;t.restApi.getHasUserAlreadyReviewed(t.settings.commentsThreadKey).then(function(e){e&&e.AuthorAlreadyReviewed&&(t.newCommentForm().hide(),t.newCommentFormButton().hide(),t.newReviewFormReplacement().show(),t.newCommentRequiresAuthentication().hide(),t.hasUserReviewed=!0)})},initializeHandlers:function(){var e=this;e.commentsLoadMoreButton().click(function(){return e.maxCommentsToShow+=e.settings.commentsPerPage,e.loadComments(e.commentsTakenSoFar,e.settings.commentsPerPage),!1}),e.commentsContainer().on("click",'[data-sf-role="comments-read-full-comment-button"]',function(e){if(e&&e.target)return o(e.target).hide().siblings().show(),o(e.target).siblings('[data-sf-role="comments-read-substr-comment-header"]').hide(),!1}),e.commentsSortNewButton().click(function(){return e.sortComments(!0),e.commentsSortNewButton().addClass(e.isSelectedSortButtonCssClass),e.commentsSortOldButton().removeClass(e.isSelectedSortButtonCssClass),!1}),e.commentsSortOldButton().click(function(){return e.sortComments(!1),e.commentsSortOldButton().addClass(e.isSelectedSortButtonCssClass),e.commentsSortNewButton().removeClass(e.isSelectedSortButtonCssClass),!1}),e.newCommentFormButton().click(function(){return o("html, body").animate({scrollTop:e.newCommentForm().offset().top},1e3),!1}),e.newCommentSubmitButton().click(function(){return e.settings.isDesignMode||(e.errorMessage().hide(),e.getElementByDataSfRole("error-message").find("span").text(""),e.getElementByDataSfRole("error-message").hide(),e.submitNewComment()),!1}),e.captchaRefreshLink().click(function(){return e.captchaRefresh(),!1}),e.newCommentMessage().focus(function(){e.isUserAuthenticated||e.commentsNewLoggedOutView().show()})},initialize:function(){this.initializeProperties(),this.initializeUserStatus(),this.initializeComments(),this.initializeHandlers()}},window.personalizationManager?window.personalizationManager.addPersonalizedContentLoaded(function(){new e}):o(function(){new e})}(jQuery);
//# sourceMappingURL=comments-list.min.js.map