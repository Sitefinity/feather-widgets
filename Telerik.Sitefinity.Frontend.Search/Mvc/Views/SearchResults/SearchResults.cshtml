@model Telerik.Sitefinity.Frontend.Search.Mvc.Models.ISearchResultsModel

@using Telerik.Sitefinity.Frontend.Mvc.Helpers;
@using Telerik.Sitefinity.Frontend.Search.Mvc.Models;
@using Telerik.Sitefinity.Modules.Pages;

<section class="section @Model.CssClass">
    <div class="container">
        <div class="col-md-8 col-md-offset-2 row--border">
            <div class="row text-center">
                <h1><span>@Model.Results.TotalCount &nbsp;</span>@Html.Raw(Model.ResultText)</h1>
                @if(Model.AllowSorting)
                {
                    @Html.DropDownList("UserSort",
                         new[]
                         {
                              new SelectListItem { Text="Relevance", Value= OrderByOptions.Relevance.ToString(), Selected = OrderByOptions.Relevance==Model.OrderBy },
                              new SelectListItem { Text="Newest first", Value= OrderByOptions.Newest.ToString(), Selected = OrderByOptions.Newest==Model.OrderBy },
                              new SelectListItem { Text="Oldest first", Value= OrderByOptions.Oldest.ToString(), Selected = OrderByOptions.Oldest==Model.OrderBy },
                              new SelectListItem { Text="New-modified first", Value= OrderByOptions.NewModified.ToString(), Selected = OrderByOptions.NewModified==Model.OrderBy }
                         }
                    )
                }
            </div>
            <div id="languageSelector">
                <span>@Html.Resource("ChangeResultsLanguageLabel") </span>
                @for (var i = 0; i < Model.Languages.Length; i++)
                {
                    <a href="" data-sf-value="@Model.Languages[i].Name">@Model.Languages[i].DisplayName</a>
                    if (i < Model.Languages.Length - 2)
                    {
                        <span>, </span>
                    }
                    else if (i == Model.Languages.Length - 2)
                    {
                        <span> @Html.Resource("OrLabel") </span>
                    }
                }     
            </div>

            <div id="search-results">
                @foreach (var item in Model.Results.Data)
                {
                    <div class="row" style="margin-bottom: 10px;">
                        <h3><a href="@item.GetValue("Link")">@item.GetValue("Title")</a></h3>
                        <p>@Html.Raw(item.GetValue("HighLighterResult"))</p>
                        <a href="@item.GetValue("Link")">@item.GetValue("Link")</a>
                    </div>
                }

                @if (Model.DisplayMode == ListDisplayMode.Paging && Model.Results.TotalCount != null && Model.Results.TotalCount > 1)
                {
                    @Html.Action("Index", "ContentPager", new
                    {
                        currentPage = Model.CurrentPage,
                        totalPagesCount = Model.TotalPagesCount,
                        redirectUrlTemplate = ViewBag.RedirectPageUrlTemplate
                    })
                }
            </div>
        </div>
    </div>
</section>

<script type="text/javascript">       
    $(document).ready(function () {      
        var currentLanguage = '@System.Globalization.CultureInfo.CurrentUICulture.Name';

        GetPropertyValue= function(fields, propName) {
            var propValue = "";
            if(fields.filter){
                var matchedProperties =  fields.filter(function (chain) {
                    return chain.Name === propName;
                });
            
                if(matchedProperties)
                    propValue = matchedProperties[0].Value;
            }

            return propValue;
        };

        var dataSource = new kendo.data.DataSource({	
            transport: {
                read: {
                    url: '@Url.Action("Results", "SearchResults", new { searchQuery = Request.QueryString["searchQuery"], indexCatalogue = Request.QueryString["indexCatalogue"] })',
                    dataType: 'json'
                }
            },
            serverPaging: true,
            pageSize: @Model.ItemsPerPage,
            schema: {
                data: "Data", // records are returned in the "data" field of the response
                total: "TotalCount" // total number of records is in the "total" field of the response
            }
        });

        $('#search-results').kendoListView({
            dataSource: dataSource,
            template: kendo.template($("#template").html()),
            pageable: true
        });
       
        $("#pager").kendoPager({
            dataSource: dataSource
        });

        //Dropdownlist Selectedchange event
        $("#UserSort").change(function (value) {
            var selectedValue = $(value.currentTarget).val();
            var selectedLanguage = getSelectedLanguage();
            var url = getResultsUrl(selectedValue, selectedLanguage);

            var listView = $('#search-results').data("kendoListView");
            listView.dataSource.transport.options.read.url = url;

            //Read data source to update
            listView.dataSource.read();
        });

        // Language is selected form the list
        $("#languageSelector a").click(function (e) {
            e.preventDefault();

            var language = $(this).attr('data-sf-value');
            var orderBy = $("#UserSort").val();

            var url = getResultsUrl(orderBy, language);
            var listView = $('#search-results').data("kendoListView");
            listView.dataSource.transport.options.read.url = url;

            //Read data source to update
            listView.dataSource.read();

            $("#languageSelector a").removeClass("sfSelected");
            $(this).addClass("sfSelected");
        });

        // Returns url with all needed parameters
        function getResultsUrl(orderBy, language) {
            return '@(Url.Action(
                "Results",
                "SearchResults",
                new {
                    searchQuery = Request.QueryString["searchQuery"],
                    indexCatalogue = Request.QueryString["indexCatalogue"]
                }))' + '?orderBy=' + orderBy + '&language=' + language;
        }

        // Returns the language of the listed results 
        function getSelectedLanguage() {
            return $("#languageSelector a.sfSelected").attr('data-sf-value') || currentLanguage;
        }
    });
</script>
